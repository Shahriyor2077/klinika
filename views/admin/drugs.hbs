{{> admin-sidebar activePage="drugs"}}

<div class="main-content">
    {{> alerts}}

    <h2 class="fw-bold mb-4"><i class="bi bi-capsule me-2"></i>Dorilar</h2>

    <div class="row">
        <div class="col-md-5">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h6 class="m-0"><i class="bi bi-plus-circle me-2"></i>Yangi dori qo'shish</h6>
                </div>
                <div class="card-body">
                    <form action="/admin/drugs/add" method="POST">
                        <div class="mb-3">
                            <label class="form-label">Dori nomi</label>
                            <input type="text" name="name" class="form-control" placeholder="Dori nomi" minlength="2"
                                maxlength="100" required>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Min yosh</label>
                                <input type="number" name="minAge" class="form-control" value="0" min="0" max="100">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Max yosh</label>
                                <input type="number" name="maxAge" class="form-control" value="100" min="0" max="100">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-6">
                                <label class="form-label">Miqdori</label>
                                <input type="number" name="quantity" class="form-control" value="0" min="0">
                            </div>
                            <div class="col-6">
                                <label class="form-label">Narxi (so'm)</label>
                                <input type="number" name="price" class="form-control" value="0" min="0">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Yaroqlilik muddati</label>
                            <input type="date" name="expiryDate" class="form-control">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Izoh (ixtiyoriy)</label>
                            <input type="text" name="description" class="form-control" placeholder="Masalan: yarimta">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">
                            <i class="bi bi-plus-lg me-2"></i>Qo'shish
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-md-7">
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light">
                    <h6 class="m-0">Dorilar ro'yxati ({{length drugs}} ta)</h6>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Nomi</th>
                                    <th>Yosh</th>
                                    <th>Miqdori</th>
                                    <th>Narxi</th>
                                    <th>Muddat</th>
                                    <th>Amallar</th>
                                </tr>
                            </thead>
                            <tbody>
                                {{#each drugs}}
                                <tr>
                                    <td>{{inc @index}}</td>
                                    <td>
                                        <span class="fw-semibold">{{this.name}}</span>
                                        {{#if this.description}}
                                        <br><small class="text-muted">{{this.description}}</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <span class="badge bg-info">{{#if
                                            this.minAge}}{{this.minAge}}{{else}}0{{/if}}-{{#if
                                            this.maxAge}}{{this.maxAge}}{{else}}100{{/if}}</span>
                                    </td>
                                    <td>
                                        <span
                                            class="badge {{#if (gt this.quantity 0)}}bg-success{{else}}bg-danger{{/if}}">{{#if
                                            this.quantity}}{{this.quantity}}{{else}}0{{/if}}</span>
                                    </td>
                                    <td>
                                        {{#if this.price}}{{this.price}}{{else}}0{{/if}} so'm
                                    </td>
                                    <td>
                                        {{#if this.expiryDate}}
                                        <small>{{formatDate this.expiryDate}}</small>
                                        {{else}}
                                        <small class="text-muted">-</small>
                                        {{/if}}
                                    </td>
                                    <td>
                                        <div class="d-flex gap-1">
                                            <button type="button" class="btn btn-sm btn-primary edit-drug-btn"
                                                data-id="{{this._id}}" data-name="{{this.name}}"
                                                data-minage="{{#if this.minAge}}{{this.minAge}}{{else}}0{{/if}}"
                                                data-maxage="{{#if this.maxAge}}{{this.maxAge}}{{else}}100{{/if}}"
                                                data-quantity="{{#if this.quantity}}{{this.quantity}}{{else}}0{{/if}}"
                                                data-price="{{#if this.price}}{{this.price}}{{else}}0{{/if}}"
                                                data-expiry="{{formatDate this.expiryDate 'input'}}"
                                                data-description="{{this.description}}" title="Tahrirlash">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <form action="/admin/drugs/delete/{{this._id}}?_method=DELETE" method="POST"
                                                class="d-inline">
                                                <button type="button" class="btn btn-sm btn-danger"
                                                    data-confirm="Dorini o'chirmoqchimisiz?" title="O'chirish">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </td>
                                </tr>
                                {{else}}
                                <tr>
                                    <td colspan="7" class="text-center text-muted py-4">Dorilar yo'q</td>
                                </tr>
                                {{/each}}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Tahrirlash Modal -->
<div class="modal fade" id="editDrugModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dorini tahrirlash</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editDrugForm" method="POST">
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Dori nomi</label>
                        <input type="text" name="name" id="editName" class="form-control" required>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Min yosh</label>
                            <input type="number" name="minAge" id="editMinAge" class="form-control" min="0" max="100">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Max yosh</label>
                            <input type="number" name="maxAge" id="editMaxAge" class="form-control" min="0" max="100">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Miqdori</label>
                            <input type="number" name="quantity" id="editQuantity" class="form-control" min="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Narxi (so'm)</label>
                            <input type="number" name="price" id="editPrice" class="form-control" min="0">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Yaroqlilik muddati</label>
                        <input type="date" name="expiryDate" id="editExpiry" class="form-control">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Izoh</label>
                        <input type="text" name="description" id="editDescription" class="form-control">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Bekor qilish</button>
                    <button type="submit" class="btn btn-primary">Saqlash</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        var editDrugModal = document.getElementById('editDrugModal');
        var editModal = new bootstrap.Modal(editDrugModal);

        document.querySelectorAll('.edit-drug-btn').forEach(function (btn) {
            btn.addEventListener('click', function () {
                document.getElementById('editDrugForm').action = '/admin/drugs/edit/' + this.getAttribute('data-id');
                document.getElementById('editName').value = this.getAttribute('data-name');
                document.getElementById('editMinAge').value = this.getAttribute('data-minage') || '0';
                document.getElementById('editMaxAge').value = this.getAttribute('data-maxage') || '100';
                document.getElementById('editQuantity').value = this.getAttribute('data-quantity') || '0';
                document.getElementById('editPrice').value = this.getAttribute('data-price') || '0';
                document.getElementById('editExpiry').value = this.getAttribute('data-expiry') || '';
                document.getElementById('editDescription').value = this.getAttribute('data-description') || '';
                editModal.show();
            });
        });
    });
</script>